{% extends 'base.html' %}
{% load thumbnail %}
{% load waffle_tags %}
{% load markup %}
{% load urlize_target_blank %}

{% block navbar %}
	<ul class="nav nav-justified">
      <li><button type="button" class="btn hubnav"
{% flag section_how %}
									data-toggle="collapse"
									data-target="#collapseOne"
{% endflag %}
									data-parent="#accordian">HOW</button></li>
      <li><button type="button" class="btn hubnav"
{% flag section_we %}
									data-toggle="collapse"
									data-target="#collapseTwo"
{% endflag %}
									data-parent="#accordian">WE</button></li>
      <li><button type="button" class="btn hubnav"
{% flag section_work %}
									data-toggle="collapse"
									data-target="#collapseThree"
{% endflag %}
									data-parent="#accordian">WORK</button></li>
      <li><button type="button" class="btn hubnav"
{% flag section_now %}
									data-toggle="collapse"
									data-target="#collapseFour"
{% endflag %}
									data-parent="#accordian">NOW</button></li>

		</ul>
{% endblock %}

{% block bodytag %}
{% if request.user.is_anonymous %}
<body class="" id="splash-page">
{% else %}
<body class="{% block bodyclass %}{% endblock %}" id="index-page{% block bodyid %}{% endblock %}">
{% endif %}
{% endblock %}

{% block content %}

{% if request.user.is_anonymous %}
<h1></h1>

<div class="" id="video-fallback">
<a href="#" 
   id="play-placeholder"
   style="color: #ddd"
	 onclick="$('#video2').show();$('#video2')[0].play();$('#play-placeholder').hide();return false">
	<img src="{{STATIC_URL}}img/spokehub_manifesto.png" id="main-placeholder"/>
</a>

<video class="video-js vjs-default-skin"
        id="video2" width="1920" height="1080">
	<source src="http://spokehub-video.s3.amazonaws.com/spokehub_manifesto.mp4?d={% now "U"%}">
	<source src="http://spokehub-video.s3.amazonaws.com/spokehub_manifesto.mp4?d={% now "U"%}"
        type="video/mp4">
</video>
</div>

<script>

// replace the autoplay attribute, only when the video
// is initially visible 

$(document).ready(function() {
   $('#play-placeholder').fadeIn("slow", function() {console.log('faded in')});
});

</script>
{% else %}

<div class="panel-group" id="accordion">
  <div class="panel panel-default">
    <a {% flag section_how %} data-toggle="collapse"
			 data-parent="#accordion" href="#collapseOne"{% endflag %}>
    	<div id="hub1" class="panel-heading">
      	<div class="panel-title"> 
         How
        </div>
        <div class="desc">Cross-functional conversations between Art, Design, and Strategy</div>
        <span class="glyphicon glyphicon-play"></span>
        
	    </div>
     </a>
{% flag section_how %}
    <div id="collapseOne" class="panel-collapse collapse">
      <div class="panel-body">
		<div class="container">
       	<div class="panelbreak white"></div>
			 {% if conversation %}

			 <form action="/item/{{conversation.id}}/reply/" method="post"
						 enctype="multipart/form-data" role="form">
				 <div class="modal fade" id="add-text-reply">
					 <div class="modal-dialog">
						 <div class="modal-content">
							 <div class="modal-header">
								 <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
								 <h4 class="modal-title">Add Reply</h4>
							 </div>
							 <div class="modal-body">

								 <div class="form-group">
									 <label for="comment-body">Comment</label>
									 <textarea name="body" class="form-control" rows="10"
														 id="comment-body"></textarea>
								 </div>

							 </div>
							 <div class="modal-footer">
								 <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
								 <input type="submit" class="btn btn-primary" value="Reply"/>
							 </div>
						 </div><!-- /.modal-content -->
					 </div><!-- /.modal-dialog -->
				 </div><!-- /.modal -->
			 </form>

			 <form action="/item/{{conversation.id}}/reply/" method="post"
						 enctype="multipart/form-data" role="form">
				 <div class="modal fade" id="add-link-reply">
					 <div class="modal-dialog">
						 <div class="modal-content">
							 <div class="modal-header">
								 <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
								 <h4 class="modal-title">Add Link Reply</h4>
							 </div>
							 <div class="modal-body">

								 <div class="form-group">
									 <label for="link-url">URL</label>
									 <input type="text" name="url" class="form-control"
									 id="link-url" placeholder="http://" />
								 </div>

								 <div class="form-group">
									 <label for="link-title">Link Title</label>
									 <input type="text" name="title" class="form-control"
									 id="link-title" />
								 </div>

							 </div>
							 <div class="modal-footer">
								 <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
								 <input type="submit" class="btn btn-primary" value="Reply"/>
							 </div>
						 </div><!-- /.modal-content -->
					 </div><!-- /.modal-dialog -->
				 </div><!-- /.modal -->
			 </form>

			 <form action="/item/{{conversation.id}}/reply/" method="post"
						 enctype="multipart/form-data" role="form">
				 <div class="modal fade" id="add-image-reply">
					 <div class="modal-dialog">
						 <div class="modal-content">
							 <div class="modal-header">
								 <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
								 <h4 class="modal-title">Add Image Reply</h4>
							 </div>
							 <div class="modal-body">

								 <div class="form-group">
									 <label for="exampleInputFile">Image</label>
									 <input type="file" id="image" name="image">
								 </div>

								 <div class="form-group">
									 <label for="comment-body">Caption</label>
									 <textarea name="body" class="form-control" rows="10"
														 id="comment-body"></textarea>
								 </div>

							 </div>
							 <div class="modal-footer">
								 <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
								 <input type="submit" class="btn btn-primary" value="Reply"/>
							 </div>
						 </div><!-- /.modal-content -->
					 </div><!-- /.modal-dialog -->
				 </div><!-- /.modal -->
			 </form>


       <h2>{{conversation.title}}</h2>
			 {{conversation.body|markdown}}
			 <div class="panelbreak white"></div>
			 <div class="addvoice">
			 	<p>Join the conversation:
				 <ul class="list-inline">
					 <li><a href="#add-text-reply" data-toggle="modal" data-target="#add-text-reply"><img src="/media/img/text_convo.png"></a></li>
					 <li><a href="#add-link-reply" data-toggle="modal" data-target="#add-link-reply" ><img src="/media/img/link_convo.png"></a></li>
					 <li><a href="#add-image-reply" data-toggle="modal" data-target="#add-image-reply"><img src="/media/img/image_convo.png"></a></li>
				 </ul>
			 </p>
			 </div>
			 			 <div class="panelbreak white"></div>

			  <div class="hubconvo">

				{% for reply_one, reply_two in conversation.reply_pairs %}

				 <div class="row">
					 <div class="col-sm-1 col-md-1">
						 <a href="/accounts/{{reply_one.author.username}}/"><img class="mugshot" src="{{ reply_one.author.get_profile.get_mugshot_url }}" 
									class="user_icon" width="100" height="100"></a>
						 </div>
					<div class="col-sm-5 col-md-5">
						<div class="convoblock">
							<div class="convoheader">
								<div class="user_name"><a href="/accounts/{{reply_one.author.username}}/">{{reply_one.author.username}}</a>
								| {{reply_one.author.get_profile.discipline1}}{% if reply_one.author.get_profile.discipline2 %} /
								{{reply_one.author.get_profile.discipline2}}{% endif %}</div>
								<div class="user_time">{{reply_one.added|timesince}}
								ago  |  {{reply_one.author.get_profile.city}}, {{reply_one.author.get_profile.country}}</div>
								</div>
								       <div class="panelbreak black"></div>
								       
								<div class="convocontent">
										{% if reply_one.url %}
								<h3><a target="_blank" href="{{reply_one.url}}"><span class="glyphicon glyphicon-link"></span>{% if reply_one.title %}
								{{reply_one.title}}{% else %}{{reply_one.url}}{% endif %}</h3>
								{% endif %}
								{{reply_one.body|markdown}}
											 {% if reply_one.image %}
											 <img src="{% thumbnail reply_one.image 400x400 %}" />
								{% endif %}
								</div>
						</div>
					</div>
{% if reply_two %}
					<div class="col-sm-5 col-md-5">
						<div class="convoblock">
							<div class="convoheader">
								<div class="user_name"><a href="/accounts/{{reply_two.author.username}}/">{{reply_two.author.username}}</a>
									| {{reply_two.author.get_profile.discipline1}}
									{% if reply_two.author.get_profile.discipline1 %}
									/ {{reply_two.author.get_profile.discipline2}}{% endif %}</div>
								<div class="user_time">{{reply_two.added|timesince}} ago  |  {{reply_two.author.get_profile.city}}, {{reply_two.author.get_profile.country}}</div>
								</div>
								 <div class="panelbreak black"></div>
									{% if reply_two.url %}
									<h3><a target="_blank" href="{{reply_two.url}}"><span class="glyphicon glyphicon-link"></span>{% if reply_two.title %}
									{{reply_two.title}}{% else %}{{reply_two.url}}{% endif %}</h3>
									{% endif %}
											 {{reply_two.body|markdown}}
											 {% if reply_two.image %}
											 <img src="{% thumbnail reply_two.image 400x400 %}" />
								{% endif %}
								
						</div>
					</div>
					<div class="col-sm-1 col-md-1">
						 <a href="/accounts/{{reply_two.author.username}}/"><img class="mugshot" src="{{ reply_two.author.get_profile.get_mugshot_url }}" 
									class="user_icon" width="100" height="100"></a>
					</div>
{% endif %}
				 </div>
				 {% endfor %}

				</div>
			 {% else %}

			 <p>No conversations yet...</p>
			 {% endif %}

				</div>
      </div>
    </div>
{% endflag %}
  </div>
			 
		

  <div class="panel panel-default">
  <a {% flag section_we %}data-toggle="collapse"
		 data-parent="#accordion" href="#collapseTwo"{% endflag %}>
  	 <div id="hub2" class="panel-heading">
      <div class="panel-title">
          We        
      </div>
      <div class="desc">A MANIFESTO OF (TROUBLE) MAKERS</div>
      <span class="glyphicon glyphicon-play"></span>
    </div>
      </a>
{% flag section_we %}
    <div id="collapseTwo" class="panel-collapse collapse">
      <div class="panel-body">
				<div class="container video">
<iframe src="//player.vimeo.com/video/104999392?portrait=0&badge=0&byline=0&title=0" width="900"height="506" frameborder="0" webkitallowfullscreen
				mozallowfullscreen allowfullscreen></iframe>
				</div>
      </div>
    </div>
{% endflag %}
  </div>

  <div class="panel panel-default">
<a {% flag section_work %} data-toggle="collapse"
	 data-parent="#accordion" href="#collapseThree"{% endflag %}>  	
    <div id="hub3" class="panel-heading">
      <div class="panel-title">
          Work        
      </div>
      <div class="desc">Shiny ideas + blood, sweat and tears</div>
      <span class="glyphicon glyphicon-play"></span>
    </div>
</a>
{% flag section_work %}
    <div id="collapseThree" class="panel-collapse collapse">
      <div class="panel-body">
      	
<ul class="bxslider">
    	{% for ws in work_samples %}
        	<li><img src="{% thumbnail ws.image 1140x700 %}" alt="{{ws.title}}" title="{{ws.title}} by {{ws.user.username}}"/></li>
       {% endfor %}
</ul>
    </div>
	</div>
</div>
{% endflag %}

  </div>

  <div class="panel panel-default active-panel">
<a {% flag section_now %}data-toggle="collapse"
	 data-parent="#accordion" href="#collapseFour"{% endflag %}>
  	    <div id="hub4" class="panel-heading">
      <div class="panel-title">
          Now
      </div>
      <div class="desc">Updates in Hub Mean Time (HMT)</div>
      <span class="glyphicon glyphicon-play"></span>
    </div>
      </a>
{% flag section_now %}
    <div id="collapseFour" class="panel-collapse collapse in">
      <div class="panel-body">
				<div id="nowtiles" data-masonry-options='{ "gutter": 30 }'>

					{% for post in now_posts %}
					<div class="nowtile">
						<div class="nowtileheader"><a href="/accounts/{{post.user.username}}/">{{post.user.username}}</a> |	{{post.user.get_profile.city}}, {{post.user.get_profile.country}}
						</div>
						{% if post.image_url %}
						<img src="{{post.image_url}}"
								 width="{{post.image_width}}"
								 height="{{post.image_height}}" /><br />
						{% endif %}
						<p>{{post.text|urlize|url_target_blank}}</p>
						<div class="nowtilefooter">
						<a target="_blank" href="{{post.external_link}}">{{post.created|timesince}} ago</a>
						</div>
					</div>
					{% endfor %}
				
     		</div>
				{% if now_posts.has_next %}
				<p id="now-nav"><a href="/?page={{now_posts.next_page_number}}">load more</a></p>
				{% endif %}
    </div>
  </div>
{% endflag %}
</div>

{% endif %}
{% endblock %}

{% block js %}
{% if request.user.is_anonymous %}
{% else %}
<script src="/media/js/masonry.pkgd.js"></script>
<script src="/media/js/jquery.bxslider.min.js"></script>
<script src="/media/js/jquery.infinitescroll.min.js"></script>

<script>
	$(document).ready(function(){
  $('.bxslider').bxSlider({
  	captions: true,
  	mode: 'fade'
  });
});

</script>

<script>
	var $container = $('#nowtiles');
	// initialize
	$('#nowtiles').masonry({
    columnWidth: 40,
    itemSelector: '.nowtile'
  });

  $container.infinitescroll({
      navSelector  : '#now-nav',
      nextSelector : '#now-nav a',
      itemSelector : '.nowtile',

      errorCallback: function () { console.log('had an error'); },

      loading: {
          finishedMsg: 'No more pages to load.'
//          img: 'http://i.imgur.com/6RMhx.gif'
        }
      },

      // trigger Masonry as a callback
      function( newElements ) {
        // hide new items while they are loading
        var $newElems = $( newElements ).css({ opacity: 0 });
        // ensure that images load before adding to masonry layout
// imagesLoaded seems to be broken...
// going without for now..
//        $newElems.imagesLoaded(function(){
          // show elems now they're ready
          $newElems.animate({ opacity: 1 });
          $container.masonry( 'appended', $newElems, true );
//        });

// don't know why, but it seems that I need to manually
// detect the end of the scrolling and stop it
// or it does weird stuff...
        if ($newElems.length < 50) {
           $container.infinitescroll('destroy');
           return;
        }

      }
    );

</script>


<script>
$(".panel").on('hidden.bs.collapse', function (e) {
   $(e.target).parent().removeClass('active-panel');
});
$(".panel").on('shown.bs.collapse', function (e) {
   $(e.target).parent().addClass('active-panel');
});
</script>


{% endif %}
{% endblock %}
